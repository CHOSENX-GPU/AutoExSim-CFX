# ç»„å†…æ–°é›†ç¾¤CFXæ¨¡æ¿ä½¿ç”¨è¯´æ˜

## ğŸ“‹ æ¦‚è¿°

æˆ‘ä»¬ä¸ºç»„å†…æ–°é›†ç¾¤åˆ›å»ºäº†ä¸€ä¸ªç»Ÿä¸€çš„CFXä½œä¸šè„šæœ¬æ¨¡æ¿ï¼Œè¯¥æ¨¡æ¿ï¼š

- âœ… **ç»Ÿä¸€å¤„ç†**ï¼šè‡ªåŠ¨å¤„ç†å¸¦/ä¸å¸¦åˆå§‹æ–‡ä»¶çš„è®¡ç®—ä»»åŠ¡
- âœ… **èŠ‚ç‚¹é€‚é…**ï¼šè‡ªåŠ¨é€‚é…å•èŠ‚ç‚¹å’Œå¤šèŠ‚ç‚¹å¹¶è¡Œè®¡ç®—
- âœ… **ç¬¦åˆä¹ æƒ¯**ï¼šä½¿ç”¨`.sbatch`æ‰©å±•åï¼Œç¬¦åˆé›†ç¾¤ä½¿ç”¨ä¹ æƒ¯
- âœ… **åŸºäºå®é™…**ï¼šåŸºäºç»„å†…é›†ç¾¤çš„çœŸå®é…ç½®å’Œè„šæœ¬ä¼˜åŒ–

## ğŸ¯ æ¨¡æ¿ç‰¹ç‚¹

### 1. ç»Ÿä¸€æ¨¡æ¿è®¾è®¡
ä¸å†éœ€è¦é€‰æ‹©ä¸åŒçš„æ¨¡æ¿ç±»å‹ï¼Œä¸€ä¸ªæ¨¡æ¿å¤„ç†æ‰€æœ‰æƒ…å†µï¼š
- æ ‡å‡†CFXè®¡ç®—ï¼ˆæ— åˆå§‹æ–‡ä»¶ï¼‰
- å¸¦åˆå§‹æ–‡ä»¶çš„CFXè®¡ç®—
- å•èŠ‚ç‚¹å¹¶è¡Œè®¡ç®—
- å¤šèŠ‚ç‚¹å¹¶è¡Œè®¡ç®—

### 2. æ™ºèƒ½æ¡ä»¶å¤„ç†
æ¨¡æ¿å†…éƒ¨ä½¿ç”¨Jinja2æ¡ä»¶è¯­å¥è‡ªåŠ¨å¤„ç†ï¼š
```jinja
{% if initial_file %}
# å¸¦åˆå§‹æ–‡ä»¶çš„è®¡ç®—å‘½ä»¤
$CFX -def $INPUT -ini-file $INITIAL -par-dist $HLIST -start-method "Platform MPI Distributed Parallel"
{% else %}
# æ ‡å‡†è®¡ç®—å‘½ä»¤  
$CFX -def $INPUT -par-dist $HLIST -start-method "Platform MPI Distributed Parallel"
{% endif %}
```

### 3. èŠ‚ç‚¹åˆ†é…ç­–ç•¥
```bash
{% if nodes > 1 %}
# å¤šèŠ‚ç‚¹ï¼šåŠ¨æ€æ„å»ºä¸»æœºåˆ†å¸ƒåˆ—è¡¨
# è‡ªåŠ¨ç”Ÿæˆç±»ä¼¼ "node1*32,node2*32" çš„åˆ†å¸ƒ
{% else %}
# å•èŠ‚ç‚¹ï¼šç›´æ¥ä½¿ç”¨å½“å‰èŠ‚ç‚¹
HLIST="$(hostname)*32"
{% endif %}
```

## ğŸ“ æ–‡ä»¶ç»“æ„

```
templates/
â”œâ”€â”€ CFX_Group_Cluster.sbatch.j2    # ç»„å†…æ–°é›†ç¾¤ç»Ÿä¸€æ¨¡æ¿
â”œâ”€â”€ CFX_University.slurm.j2        # å­¦æ ¡é›†ç¾¤æ¨¡æ¿
â”œâ”€â”€ CFX_Group_PBS.pbs.j2           # ç»„å†…è€é›†ç¾¤PBSæ¨¡æ¿
â””â”€â”€ create_def_*.pre.j2             # CFXå‰å¤„ç†æ¨¡æ¿
```

## âš™ï¸ é…ç½®æ›´æ–°

é…ç½®æ–‡ä»¶ `config/local_cfx_new_cluster.yaml` ä¸­çš„å…³é”®é…ç½®ï¼š

```yaml
# é›†ç¾¤é…ç½®
cluster_type: "group_new"
scheduler_type: "SLURM"

# æ¨¡æ¿é…ç½® - ç»Ÿä¸€ä½¿ç”¨ä¸€ä¸ªæ¨¡æ¿
sbatch_template: "CFX_Group_Cluster.sbatch.j2"

# CFXç¯å¢ƒé…ç½®ï¼ˆåŸºäºå®é™…é›†ç¾¤è·¯å¾„ï¼‰
remote_cfx_bin_path: "/home/opt/ansys/ansys2022r1/v221/CFX/bin/"

# SLURMä½œä¸šé…ç½®
partition: "batch"                   # ç»„å†…é›†ç¾¤ä½¿ç”¨batchåˆ†åŒº
tasks_per_node: 32                   # æ¯èŠ‚ç‚¹32æ ¸
exclude_nodes: "master"              # æ’é™¤masterèŠ‚ç‚¹
```

## ğŸ”„ æ¨¡æ¿å¯¹æ¯”

### ä¹‹å‰ï¼ˆå¤šä¸ªæ¨¡æ¿ï¼‰ï¼š
- `CFX_Group_Cluster.slurm.j2` - æ ‡å‡†è®¡ç®—
- `CFX_Group_Cluster_Initial.slurm.j2` - å¸¦åˆå§‹æ–‡ä»¶
- `CFX_Group_Cluster_Single.slurm.j2` - å•èŠ‚ç‚¹
- `CFX_Group_Cluster_Simple.slurm.j2` - ç®€åŒ–ç‰ˆ

### ç°åœ¨ï¼ˆç»Ÿä¸€æ¨¡æ¿ï¼‰ï¼š
- `CFX_Group_Cluster.sbatch.j2` - å¤„ç†æ‰€æœ‰æƒ…å†µ

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### 1. æ ‡å‡†CFXè®¡ç®—
```python
job = {
    "name": "CFX_Standard",
    "def_file": "model.def",
    "nodes": 1,
    "allocated_cpus": 32
}
```

ç”Ÿæˆçš„è„šæœ¬ä¼šè‡ªåŠ¨æ‰§è¡Œï¼š
```bash
cfx5solve -def model.def -par-dist $(hostname)*32 -start-method "Platform MPI Distributed Parallel"
```

### 2. å¸¦åˆå§‹æ–‡ä»¶è®¡ç®—
```python
job = {
    "name": "CFX_With_Initial", 
    "def_file": "model.def",
    "initial_file": "restart.res",
    "nodes": 1,
    "allocated_cpus": 32
}
```

ç”Ÿæˆçš„è„šæœ¬ä¼šè‡ªåŠ¨æ‰§è¡Œï¼š
```bash
cfx5solve -def model.def -ini-file restart.res -par-dist $(hostname)*32 -start-method "Platform MPI Distributed Parallel"
```

### 3. å¤šèŠ‚ç‚¹å¹¶è¡Œè®¡ç®—
```python
job = {
    "name": "CFX_Multi_Node",
    "def_file": "model.def", 
    "nodes": 2,
    "allocated_cpus": 32
}
```

ç”Ÿæˆçš„è„šæœ¬ä¼šè‡ªåŠ¨æ„å»ºä¸»æœºåˆ—è¡¨ï¼š
```bash
# è‡ªåŠ¨ç”Ÿæˆç±»ä¼¼ "node1*32,node2*32" çš„åˆ†å¸ƒ
cfx5solve -def model.def -par-dist $HLIST -start-method "Platform MPI Distributed Parallel"
```

## ğŸ¨ æ¨¡æ¿ä¼˜åŠ¿

### 1. ç®€åŒ–ç»´æŠ¤
- åªéœ€ç»´æŠ¤ä¸€ä¸ªæ¨¡æ¿æ–‡ä»¶
- å‡å°‘ä»£ç é‡å¤å’Œä¸ä¸€è‡´æ€§
- æ›´å®¹æ˜“è¿›è¡Œç‰ˆæœ¬æ§åˆ¶

### 2. ç”¨æˆ·å‹å¥½
- ä¸éœ€è¦é€‰æ‹©æ¨¡æ¿ç±»å‹
- è‡ªåŠ¨é€‚é…ä¸åŒè®¡ç®—åœºæ™¯
- ç»Ÿä¸€çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

### 3. åŸºäºå®é™…
- åŸºäºç»„å†…é›†ç¾¤çœŸå®çš„CFXè„šæœ¬
- éµå¾ªé›†ç¾¤çš„å®é™…ä½¿ç”¨ä¹ æƒ¯
- ä½¿ç”¨`.sbatch`æ‰©å±•åç¬¦åˆè§„èŒƒ

### 4. æ™ºèƒ½å¤„ç†
- è‡ªåŠ¨æ£€æµ‹æ–‡ä»¶å­˜åœ¨æ€§
- æ™ºèƒ½é€‰æ‹©å¹¶è¡Œåˆ†å¸ƒç­–ç•¥
- è¯¦ç»†çš„è®¡ç®—ç»“æœæ£€æŸ¥

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### SLURM vs SBATCH
- **åŠŸèƒ½**: `.slurm`å’Œ`.sbatch`æ–‡ä»¶åŠŸèƒ½å®Œå…¨ç›¸åŒ
- **ä¹ æƒ¯**: ç»„å†…é›†ç¾¤æ›´å¸¸ç”¨`.sbatch`æ‰©å±•å
- **æäº¤**: éƒ½ä½¿ç”¨`sbatch`å‘½ä»¤æäº¤ä½œä¸š

### æ¨¡æ¿å¼•æ“
- ä½¿ç”¨Jinja2æ¨¡æ¿å¼•æ“
- æ”¯æŒæ¡ä»¶è¯­å¥å’Œå¾ªç¯
- å˜é‡æ›¿æ¢å’Œè¿‡æ»¤å™¨åŠŸèƒ½

### é”™è¯¯å¤„ç†
- æ–‡ä»¶å­˜åœ¨æ€§æ£€æŸ¥
- CFXæ‰§è¡Œç»“æœéªŒè¯
- è¯¦ç»†çš„é”™è¯¯æ—¥å¿—è®°å½•

## ğŸ“ˆ åç»­ä¼˜åŒ–

1. **æ€§èƒ½ç›‘æ§**: æ·»åŠ ä½œä¸šæ€§èƒ½ç›‘æ§åŠŸèƒ½
2. **è‡ªåŠ¨é‡å¯**: å¤±è´¥ä½œä¸šçš„è‡ªåŠ¨é‡å¯æœºåˆ¶
3. **ç»“æœåˆ†æ**: é›†æˆç»“æœæ–‡ä»¶è‡ªåŠ¨åˆ†æ
4. **é€šçŸ¥ç³»ç»Ÿ**: ä½œä¸šå®Œæˆçš„é‚®ä»¶é€šçŸ¥

---

*æœ€åæ›´æ–°: 2025å¹´7æœˆ22æ—¥*
